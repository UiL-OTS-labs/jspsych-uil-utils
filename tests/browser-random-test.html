<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <!-- include jsPsych first -->
    <script src="../jspsych-uil-utils-import.js" type="module"></script>
</head>
<body>
<script>
    const ITEM_TYPES = [
        "filler",
        "active",
        "passive",
        "distractor"
    ];

    const COLORS = [
        "yellow",
        "red",
        "blue",
        "green"
    ];

    const IMBALANCED_BISTATE = [
        "true",
        "true",
        "false"
    ]

    function createStimuli(n) {
        let stimuli = [];
        const N = n;
        for (let i = 0; i < N; i++) {
            stimuli.push (
                {
                    id : i + 1,
                    item_type : ITEM_TYPES[i % ITEM_TYPES.length],
                    color : COLORS[Math.floor(i / (N / COLORS.length))],
                    bi_state : IMBALANCED_BISTATE[i % IMBALANCED_BISTATE.length]
                }
            );
        }
        return stimuli;
    }

    function testMeetConstraints() {
        let impropper = [
            {a : 3},
            {a : 3}
        ];
        let propper = [
            {a : 1},
            {a : 2}
        ];
        let complex_proper = [
            {a : 1, b:2},
            {a : 2, b:3},
        ]
        let complex_improper = [
            {a : 1, b:2},
            {a : 2, b:2},
        ]

        // This catches errors when miscounting, it should be valid for {a:3}.
        // This catches errors when miscounting, it should be invalid for {a:2}.
        let multiple_non_adjacent = [
            {a : 1},
            {a : 1},
            {a : 1},
            {a : 0},
            {a : 1},
            {a : 1},
            {a : 1},
        ];

        console.assert(
            uil.randomization.stimuliMeetConstraints(
                impropper, {a : 1}
            ) === false
        );
        console.assert(
            uil.randomization.stimuliMeetConstraints(
                propper, {a : 1}
            ) === true
        );
        console.assert(
            uil.randomization.stimuliMeetConstraints(
                complex_improper, {a:1, b:1}
            ) === false
        );
        console.assert(
            uil.randomization.stimuliMeetConstraints(
                complex_proper, {a:1, b:1}
            ) === true
        );
        console.assert(
            uil.randomization.stimuliMeetConstraints(
                multiple_non_adjacent, {a:3}
            ) === true
        );
        console.assert(
            uil.randomization.stimuliMeetConstraints(
                multiple_non_adjacent, {a:2}
            ) === false
        );
        console.log("testMeetConstraints Success!");

    }

    function testRandomization() {
        /* Test randomization without constraints on order. */
        let stimuli = createStimuli(10);
        // no constraints this is just a shuffle.
        let shuffled = uil.randomization.randomizeStimuliConstraints(
            stimuli,
            {}
        );
        console.assert(shuffled !== stimuli); // there is a 1 in 10! 10 * 9 .... * 1 chance that this fails.
        shuffled = uil.randomization.randomizeStimuli(stimuli, 10);
        console.assert(shuffled !== stimuli);
        console.log("testRandomization Success!");
    }

    function testRandomizationConstraints() {
        let stimuli = createStimuli(100);
        let constraints = {item_type : 3};

        let shuffled = uil.randomization.randomizeStimuliConstraints(
            stimuli,
            constraints
        )
        console.assert(shuffled !== null && shuffled !== stimuli);
        console.assert(
            uil.randomization.stimuliMeetConstraints(shuffled, constraints)
        );

        constraints = {item_type: 2, color: 2, bi_state:10};
        shuffled = uil.randomization.randomizeStimuliConstraints(
            stimuli,
            constraints
        );
        console.assert(shuffled !== null && shuffled !== stimuli);
        console.assert(
            uil.randomization.stimuliMeetConstraints(shuffled, constraints)
        );

        console.log("testRandomizationConstraints Success!");
    }

    function testRandomizationBenchmarks()
    {
        let constraints = {item_type : 3};
        const niters = 100;

        function benchmarkFunction(N, func, funcname, constraints, output) {
            [10, 100, 1000, 10000].forEach((num_stim) =>{
                output.function = funcname;
                output.constraints = constraints;
                let stims = createStimuli(num_stim);
                tstart = performance.now();
                for (let i = 0; i < N; i++) {
                    let shuffled = func(stims, constraints);
                }
                tend = performance.now();
                output[`${num_stim} items shuffle time`] =
                    String((tend - tstart) / N) + " ms";
            });
        }

        let output = {};
        benchmarkFunction(
            niters,
            uil.randomization.randomShuffle,
            "randomShuffle",
            constraints,
            output
        );
        console.log(output);

        output = {};
        benchmarkFunction(
            niters,
            uil.randomization.randomizeStimuliConstraints,
            "randomizeStimululiConstraints",
            constraints,
            output
        );
        console.log(output);

        output = {};
        benchmarkFunction(
            niters,
            uil.randomization.randomShuffleConstraints,
            "randomShuffleConstraints",
            constraints,
            output
        );
        console.log(output);


        // With some stricter constraints
        constraints = {
            item_type : 2,
            color : 2,
        };

        output = {};
        benchmarkFunction(
            niters,
            uil.randomization.randomizeStimuliConstraints,
            "randomizeStimululiConstraints",
            constraints,
            output
        );
        console.log(output);

        output = {};
        benchmarkFunction(
            niters,
            uil.randomization.randomShuffleConstraints,
            "randomShuffleConstraints",
            constraints,
            output
        );
        console.log(output);

    }

    function testRandomizationConstraintsHard() {
        let stimuli = createStimuli(100);
        let constraints = {
            bi_state : 2,
            item_type : 2,
            color : 2
        };

        /*
         * there must be a sequence true, true, false, ...., true, true, false out there
         * that is not the input and meets the constraints, it's just unlikely that it
         * will ever pop-up.
         * The problem that occurs eventually is that the rules need to have a false, while
         * there are only true values remaining.
         */
        let shuffled = uil.randomization.randomShuffleConstraints (
            stimuli, constraints, 100
        );
        console.assert(shuffled !== null);
        console.assert(shuffled !== stimuli);
        if (shuffled !== null) {
            console.assert(uil.randomization.stimuliMeetConstraints(shuffled, constraints));
        }
        console.log("testRandomizationConstraintsHard Success!");
    }

    function testUtils() {
        testMeetConstraints();
        testRandomization();
        testRandomizationConstraints();
        testRandomizationConstraintsHard();
        testRandomizationBenchmarks();
    }

    window.addEventListener (
        'load',
        testUtils
    );
</script>
</body>
</html>
